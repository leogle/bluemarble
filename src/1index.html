<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta charset="utf-8" />
    <meta name="renderer" content="webkit" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="renderer" content="ie-stand" />
    <title>智慧环保综合管理平台</title>
    <link href="css/style.css" rel="stylesheet" />
    <link href="css/TimeLine.css" rel="stylesheet" />

    <script src="js/jquery-1.9.1.min.js"></script>
    <!--滚动条-->
    <script src="js/jquery.nicescroll.min.js"></script>

</head>

<body>
    <div class="main-bg">&nbsp;</div>

    <!--头部-->
    <div class="header">
        <div class="header-title">&nbsp;</div>
    </div>

    <!--左边栏-->
    <div class="left-bar-wrap">

        <!--区块1-->
        <div class="bar-box">
            <div class="bar-bottom-bg"></div>
            <h3 class="bar-title">源贡献分析</h3>
            <div class="bar-content">
                <h4 class="bar-s-title">2017年10月25日14时源解析图</h4>
                <div class="content-box">
                    <!--此处放图表-->
                    <div id="srcChart"></div>
                    <!--<img src="images/demo-chart-1.png" />-->
                </div>

                <h4 class="bar-s-title">2017年10月25日源解析变化趋势</h4>
                <div class="content-box">
                    <!--此处放图表-->
                    <div id="barChart"></div>
                    <!--<img src="images/demo-chart-2.png" />-->
                </div>
            </div>
        </div>

        <!--区块2-->
        <div class="bar-box">
            <div class="bar-bottom-bg"></div>
            <h3 class="bar-title">排放源监控</h3>
            <div class="bar-content">

                <!--站点切换-->
                <div class="site-switch-box">
                    <div class="left-site-wrap">
                        <div class="left-site-box">
                            <a class="active" id="sector1" href="javascript:void(0);" onclick="selectImgLoc(this)">广运潭</a>
                            <a id="sector2" href="javascript:void(0);" onclick="selectImgLoc(this)">经开区</a>
                            <a href="javascript:void(0);">草滩</a>
                            <a href="javascript:void(0);">纺织城</a>
                            <a href="javascript:void(0);">经开区</a>
                        </div>
                    </div>
                    <div class="right-button-box">
                        <a class="btn-left" href="javascript:void(0);">&nbsp;</a>
                        <a class="btn-right" href="javascript:void(0);">&nbsp;</a>
                    </div>
                </div>

                <div class="content-box">
                    <div class="img-box">
                        <img id="srcImg" src="images/demo-pic.jpg" />
                    </div>
                    <div class="time-line-box">
                        <div id="timelineimg"></div>
                        <!--此处放时间轴-->
                    </div>
                </div>
            </div>
        </div>
    </div>


    <div class="center-box">
        <div class="jiao-1">&nbsp;</div>
        <div class="jiao-2">&nbsp;</div>
        <div class="jiao-3">&nbsp;</div>
        <div class="jiao-4">&nbsp;</div>
        <div class="map-box">
            <!--此处放地图-->
            <!--<img src="images/demo-map.png" style="width: 100%;height: 100%;" />-->
            <div id="map" style="width: 100%;height: 100%;"></div>
            <div class="map-title">
                <img src="images/c-icon-site.png" /> 西安市
            </div>

            <!--站点类型选择-->
            <div class="map-site-box">
                <label>监测点：</label>
                <div class="site-item-box">
                    <a class="active" href="javascript:void(0);">国家网</a>
                    <a class="active" href="javascript:void(0);">省市控</a>
                    <a href="javascript:void(0);">微型站</a>
                    <a href="javascript:void(0);">污染源企业</a>
                </div>
            </div>
            <div class="map-time-line">
                <!--此处放时间轴-->
                <p style="text-align:center"> </p>

                <div id="timeline"></div>
            </div>

            <!--因子选择-->
            <div class="map-item-select">
                <span>监测项</span>
                <ul>
                    <li class="active"><a href="javascript:void(0);">AQI</a></li>
                    <li><a href="javascript:void(0);">PM2.5</a></li>
                    <li><a href="javascript:void(0);">PM10</a></li>
                    <li><a href="javascript:void(0);">SO2</a></li>
                    <li><a href="javascript:void(0);">NO2</a></li>
                    <li><a href="javascript:void(0);">CO</a></li>
                    <li><a href="javascript:void(0);">O3</a></li>
                    <li><a href="javascript:void(0);">综指</a></li>
                </ul>

                <span>背景图</span>
                <ul>
                    <li><a href="javascript:void(0);" onclick="">纯净</a></li>
                    <li><a href="javascript:void(0);">六项</a></li>
                    <li><a class="active" id="wind" href="javascript:void(0);" onclick="toggle()">风场</a></li>
                    <li><a href="javascript:void(0);">温度</a></li>
                    <li><a href="javascript:void(0);">气压</a></li>
                </ul>
            </div>

            <!--图例切换-换图片-->
            <div class="map-tip">
                <img src="images/tip-aqi.png" />
            </div>
        </div>
    </div>
    </div>
    <!--右边栏-->
    <div class="left-bar-wrap right-bar-wrap">

        <!--区块1-->
        <div class="bar-box">
            <div class="bar-bottom-bg"></div>
            <h3 class="bar-title">雷达扫描区</h3>
            <div class="bar-content">
                <div class="content-box" style="height:370px">
                    <!--此处放地图-->
                    <div class="map-box-s" style="height: 80%">
                        <div id="radarMap" style="height: 100%"></div>
                        <!-- <img src="images/demo-map-2.png" style="width: 100%; height: 100%;" />-->
                    </div>

                    <!--条件选择-->
                    <div class="form-box-wrap">
                        <div class="form-box">
                            <label>选择时间</label>
                            <input class="time-input" type="text" placeholder="请选择时间" />
                        </div>
                        <div class="form-box">
                            <label>反演结果</label>
                            <select>
                                    <option selected>气溶胶消光系数</option>
                                    <option>非球形粒子消光</option>
                                    <option>球形粒子消光</option>
                                </select>
                        </div>
                    </div>
                    <a class="map-window-btn to-large" title="最大化" href="javascript:void(0);"><img src="images/icon-to-large.png" /></a>

                </div>
            </div>
        </div>

        <!--区块2-->
        <div class="bar-box">
            <div class="bar-bottom-bg"></div>
            <div class="bar-content">
                <div class="content-box">
                    <!--功能切换-->
                    <div class="btn-switch-box">
                        <a class="active" href="javascript:void(0);">气象要素</a><a href="javascript:void(0);">区县排名</a>
                    </div>

                    <div class="img-box" style="height: auto">
                        <!--此处放图表-->
                        <div id="barChartCloud" />
                        <!--<img src="images/demo-chart-3.png" />-->
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <div class="footer">
        © 2017 西安观云信息科技有限公司 广东旭诚科技有限公司
    </div>
    <script type="text/javascript" src="https://api.map.baidu.com/api?v=2.0&ak=WrdHfTfV71jmAc5MVU33G22HxczFdSmP"></script>
    <!--<script type="text/javascript" src="http://api.map.baidu.com/library/Heatmap/2.0/src/Heatmap_min.js"></script>-->
    <script type="text/javascript" src="js/heatmap.js"></script>
    <script type="text/javascript" src="mapstyle/darkblue.js"></script>
    <script type="text/javascript" src="js/canvas2image.js"></script>
    <script type="text/javascript" src="data/xian-wind-data.js"></script>
    <script type="text/javascript" src="js/painter/wind.js"></script>
    <script type="text/javascript" src="js/dat.gui.js"></script>
    <script type="text/javascript" src="js/highcharts.js"></script>
    <script type="text/javascript" src="js/highcharts-3d.js"></script>
    <script type="text/javascript" src="js/timeline.js"></script>
    <script type="text/javascript" src="js/demo.js"></script>
    <style type="text/css">
        .anchorBL {
            display: none !important;
        }
    </style>
    <script type="text/javascript">
        var map = new BMap.Map('map', {
            minZoom: 5
        });

        map.centerAndZoom(new BMap.Point(108.7969528198, 34.1559847970), 10);
        // map.centerAndZoom('西安', 11)
        map.enableScrollWheelZoom(true);
        map.setMapStyle({
            styleJson: styleJson
        });

        getBoundary();
        /************定义canvas图层************/
        function WindOverLayer() {}
        WindOverLayer.prototype = new BMap.Overlay();

        WindOverLayer.prototype.initialize = function() {
            var canvas = document.createElement('canvas');
            canvas.id = "windCanvas";
            canvas.width = map.getSize().width;
            canvas.height = map.getSize().height;
            canvas.style.position = 'absolute';
            canvas.style.top = 0;
            canvas.style.left = 0;
            map.getPanes().labelPane.appendChild(canvas);

            this._canvas = canvas;
            this._windy = new Windy({
                map: map,
                canvas: canvas,
                data: windData
            });
        };

        WindOverLayer.prototype.draw = function() {
            var canvas = this._canvas;
            var windy = this._windy;
            var bounds = map.getBounds(); //返回当前视口的西南纬度/经度和东北纬度/经度
            var sw = bounds.getSouthWest();
            var ne = bounds.getNorthEast();
            var py = map.pointToOverlayPixel(new BMap.Point(sw.lng, ne.lat)); //经纬度转成屏幕坐标
            canvas.style.left = py.x + 'px';
            canvas.style.top = py.y + 'px';

            var points = this.invertLatLon(py); //所有站点经纬度转为canvas坐标
            var min = map.pointToOverlayPixel(new BMap.Point(sw.lng, ne.lat));
            var max = map.pointToOverlayPixel(new BMap.Point(ne.lng, sw.lat));

            windy.start([
                [min.x - py.x, min.y - py.y],
                [max.x - py.x, max.y - py.y]
            ], points);
        };

        WindOverLayer.prototype.invertLatLon = function(py) {
            var points = [];
            this._windy.options.data.forEach(function(station) {
                var px = map.pointToOverlayPixel(new BMap.Point(station[1], station[0]));
                points.push({
                    x: px.x - py.x,
                    y: px.y - py.y,
                    angle: station[2],
                    speed: station[3]
                });
            });
            return points;
        }

        WindOverLayer.prototype.updateData = function(windData) {
            var windy = windLayer._windy;
            windy.options.data = windData;
            windLayer.draw();
            finished();
        }

        var windLayer = new WindOverLayer()
        map.addOverlay(windLayer);


        var options = {
            size: .8,
            color: 'rgba(210,210,210,0.8)',
            button: function() {
                var oCanvas = document.getElementsByClassName("heatmap-canvas")[0];
                Canvas2Image.saveAsPNG(oCanvas);
            }
        };

        function finished() {
            windLayer._windy.change(options);
        };
        finished();

        function toggle() {

        }
        //GUI
        /*
        var gui = new dat.GUI({
            nameMap: {
                size: '线条大小',
                color: '线条颜色',
                button: '导出'
            }
        });

        finished();
        gui.add(options, 'size', 0.1, 10).onFinishChange(finished);
        gui.addColor(options, 'color').onChange(finished);
        gui.add(options, 'button'); 
        */
        var heatmapOverlay2;

        function addCo(map) {
            var point;
            heatmapOverlay2 = new BMapLib.HeatmapOverlay({
                "radius": 10,
                "opacity": 0.3,
                "radiusChangeByZoom": true
            });
            map.addOverlay(heatmapOverlay2);

            fetch("/data/co.json").then(function(response) {
                return response.json().then(function(json) {
                    point = json.data;

                    heatmapOverlay2.setDataSet({
                        data: point,
                        max: 16
                    });
                })
            });
        }

        map.addEventListener("zoomend", function() {
            // heatmapOverlay2.setOption({
            //    "radius": this.getZoom() * 50
            // });
        });

        //叠加图片
        var tileLayer = new BMap.TileLayer({
            isTransparentPng: true
        });
        tileLayer.getTilesUrl = function(tileCoord, zoom) {
                var x = tileCoord.x;
                var y = tileCoord.y;
                var u = '/tiles/' + zoom + '/tile-' + x + '_' + y + '.png';
                return u;
            }
            //map.addTileLayer(tileLayer);

        //addCo(map);

        //插值
        function addOverlay() {
            myHeatOverlay1 = new BMapLib.HeatmapOverlay({
                "radius": 30,
                "opacity": 0.3
            });
            map.addOverlay(myHeatOverlay1);
            fetch("/data/co.json").then(function(response) {
                return response.json().then(function(json) {
                    point = json.data;

                    myHeatOverlay1.setDataSet({
                        data: point,
                        max: 5
                    });
                })
            });
        }
        addOverlay();
    </script>

    <script type="text/javascript">
        setChart();
    </script>
    <!--雷达-->
    <script type="text/javascript">
        var radarMap = new BMap.Map('radarMap', {
            minZoom: 10
        });
        radarMap.centerAndZoom(new BMap.Point(108.917433, 34.340354), 12);
        radarMap.setMaxZoom(15);
        radarMap.enableScrollWheelZoom(true);
        radarMap.setMapStyle({
            styleJson: styleJson
        });
        var tileLayerRadar = new BMap.TileLayer({
            isTransparentPng: true
        });
        tileLayerRadar.getTilesUrl = function(tileCoord, zoom) {
            var x = tileCoord.x;
            var y = tileCoord.y;
            var u = '/tilesRadar/' + zoom + '/tile-' + x + '_' + y + '.png';
            return u;
        }
        radarMap.addTileLayer(tileLayerRadar);
    </script>

    <script type="text/javascript">
        var currentLocation = '广运潭';
        var selectImgLoc = function(obj) {
            $("#sector1")[0].setAttribute("class", "");
            $("#sector2")[0].setAttribute("class", "");
            var  location = $(obj)[0]; 
            location.setAttribute("class", "active");
            currentLocation = location.innerText;
        };

        div = $("#timeline")[0];
        offset = (div.offsetWidth - 40);
        var timeLine = $("#timeline").TimeLine({
            startTime: "2017/10/25",
            endTime: "2017/10/26",
            playTitle: "开始",
            pauseTitle: "暂停",
            playImgUrl: "/images/play.png",
            pauseImgUrl: "/images/pause.png",
            speed: 5000,
            width: offset,
            callBack: function(time) {
                //setChart();
                hour = time.substring(11, 13);
                fetch('/data/wind_' + hour + '.json').then(function(response) {
                    return response.json().then(function(json) {
                        var data = json.data;
                        WindOverLayer.prototype.updateData(data);
                    });
                });

                fetch("/data/co" + hour + ".json").then(function(response) {
                    return response.json().then(function(json) {
                        point = json.data;
                        console.log(point);
                        myHeatOverlay1.setDataSet({
                            data: point,
                            max: 5
                        });
                    })
                });

            }
        });

        div = $("#timelineimg")[0];
        offset = (div.offsetWidth - 40);
        var timeLine = $("#timelineimg").TimeLine({
            startTime: "2017/10/20",
            endTime: "2017/10/25",
            playTitle: "开始",
            pauseTitle: "暂停",
            playImgUrl: "/images/play.png",
            pauseImgUrl: "/images/pause.png",
            speed: 1000,
            width: offset,
            height: 20,
            callBack: function(time) {
                time = time.substring(11, 13);
                var img = document.getElementById("srcImg");
                img.src = '/Images/' + this.currentLocation + time + '.jpg';
            }
        });
    </script>

    <script type="text/javascript">
        setPupPoint();
    </script>
</body>

</html>

<script>
    $(document).ready(function() {
        //滚动条样式
        $(".left-bar-wrap").niceScroll({
            cursorcolor: "#1E5598",
            cursorwidth: "6px",
        });

        //点击弹出大地图
        $(".to-large").click(function() {
            $(".map-box-large-mark").fadeIn();
            $(".map-box-large-wrap").show();
        });

        //点击隐藏大地图
        $(".to-small").click(function() {
            $(".map-box-large-mark").fadeOut();
            $(".map-box-large-wrap").fadeOut();
        });
    });
</script>