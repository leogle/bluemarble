!function(t,e,a){e.h337=function(){var t={defaultRadius:40,defaultRenderer:"canvas2d",defaultGradient:{.45:"rgb(0,0,255)",.55:"rgb(0,255,255)",.65:"rgb(0,255,0)",.95:"yellow",1:"rgb(255,0,0)"},defaultMaxOpacity:1,defaultMinOpacity:0,defaultBlur:.85,defaultXField:"x",defaultYField:"y",defaultValueField:"value",plugins:{}},e=function(){var e=function(t){this._coordinator={},this._data=[],this._radi=[],this._min=0,this._max=1,this._xField=t.xField||t.defaultXField,this._yField=t.yField||t.defaultYField,this._valueField=t.valueField||t.defaultValueField,t.radius&&(this._cfgRadius=t.radius)},a=t.defaultRadius;return e.prototype={_organiseData:function(t,e){var i=t[this._xField],n=t[this._yField],r=this._radi,s=this._data,o=this._max,h=this._min,l=t[this._valueField]||1,d=t.radius||this._cfgRadius||a;return s[i]||(s[i]=[],r[i]=[]),s[i][n]?s[i][n]+=l:(s[i][n]=l,r[i][n]=d),s[i][n]>o?(e?this.setDataMax(s[i][n]):this._max=s[i][n],!1):{x:i,y:n,value:l,radius:d,min:h,max:o}},_unOrganizeData:function(){var t=[],e=this._data,a=this._radi;for(var i in e)for(var n in e[i])t.push({x:i,y:n,radius:a[i][n],value:e[i][n]});return{min:this._min,max:this._max,data:t}},_onExtremaChange:function(){this._coordinator.emit("extremachange",{min:this._min,max:this._max})},addData:function(){if(arguments[0].length>0)for(var t=arguments[0],e=t.length;e--;)this.addData.call(this,t[e]);else{var a=this._organiseData(arguments[0],!0);a&&this._coordinator.emit("renderpartial",{min:this._min,max:this._max,data:[a]})}return this},setData:function(t){var e=t.data,a=e.length;this._data=[],this._radi=[];for(var i=0;i<a;i++)this._organiseData(e[i],!1);return this._max=t.max,this._min=t.min||0,this._onExtremaChange(),this._coordinator.emit("renderall",this._getInternalData()),this},removeData:function(){},setDataMax:function(t){return this._max=t,this._onExtremaChange(),this._coordinator.emit("renderall",this._getInternalData()),this},setDataMin:function(t){return this._min=t,this._onExtremaChange(),this._coordinator.emit("renderall",this._getInternalData()),this},setCoordinator:function(t){this._coordinator=t},_getInternalData:function(){return{max:this._max,min:this._min,data:this._data,radi:this._radi}},getData:function(){return this._unOrganizeData()}},e}(),a=function(){function t(t){var a=t.element,i=this.shadowCanvas=document.createElement("canvas"),n=this.canvas=t.canvas||document.createElement("canvas"),r=(this._renderBoundaries=[1e4,1e4,0,0],getComputedStyle(t.element)||{});n.className="heatmap-canvas",this._width=n.width=i.width=+r.width.replace(/px/,""),this._height=n.height=i.height=+r.height.replace(/px/,""),this.shadowCtx=i.getContext("2d"),this.ctx=n.getContext("2d"),n.style.cssText=i.style.cssText="position:absolute;left:0;top:0;",a.style.position="relative",a.appendChild(n),this._palette=e(t),this._templates={},this._setStyles(t)}var e=function(t){var e=t.gradient||t.defaultGradient,a=document.createElement("canvas"),i=a.getContext("2d");a.width=256,a.height=1;var n=i.createLinearGradient(0,0,256,1);for(var r in e)n.addColorStop(r,e[r]);return i.fillStyle=n,i.fillRect(0,0,256,1),i.getImageData(0,0,256,1).data},a=function(t,e){var a=document.createElement("canvas"),i=a.getContext("2d"),n=t,r=t;if(a.width=a.height=2*t,1==e)i.beginPath(),i.arc(n,r,t,0,2*Math.PI,!1),i.fillStyle="rgba(0,0,0,1)",i.fill();else{var s=i.createRadialGradient(n,r,t*e,n,r,t);s.addColorStop(0,"rgba(0,0,0,1)"),s.addColorStop(1,"rgba(0,0,0,0)"),i.fillStyle=s,i.fillRect(0,0,2*t,2*t)}return a};return t.prototype={renderPartial:function(t){this._drawAlpha(t),this._colorize()},renderAll:function(t){this._clear(),this._drawAlpha(function(t){var e=[],a=t.min,i=t.max,n=t.radi,t=t.data,r=Object.keys(t),s=r.length;for(;s--;)for(var o=r[s],h=Object.keys(t[o]),l=h.length;l--;){var d=h[l],u=t[o][d],c=n[o][d];e.push({x:o,y:d,value:u,radius:c})}return{min:a,max:i,data:e}}(t)),this._colorize()},_updateGradient:function(t){this._palette=e(t)},updateConfig:function(t){t.gradient&&this._updateGradient(t),this._setStyles(t)},setDimensions:function(t,e){this._width=t,this._height=e,this.canvas.width=this.shadowCanvas.width=t,this.canvas.height=this.shadowCanvas.height=e},_clear:function(){this.shadowCtx.clearRect(0,0,this._width,this._height),this.ctx.clearRect(0,0,this._width,this._height)},_setStyles:function(t){this._blur=0==t.blur?0:t.blur||t.defaultBlur,t.backgroundColor&&(this.canvas.style.backgroundColor=t.backgroundColor),this._opacity=255*(t.opacity||0),this._maxOpacity=255*(t.maxOpacity||t.defaultMaxOpacity),this._minOpacity=255*(t.minOpacity||t.defaultMinOpacity),this._useGradientOpacity=!!t.useGradientOpacity},_drawAlpha:function(t){for(var e=this._min=t.min,i=this._max=t.max,n=(t=t.data||[]).length,r=1-this._blur;n--;){var s,o=t[n],h=o.x,l=o.y,d=o.radius,u=Math.min(o.value,i),c=h-d,p=l-d,_=this.shadowCtx;this._templates[d]?s=this._templates[d]:this._templates[d]=s=a(d,r),_.globalAlpha=(u-e)/(i-e),_.drawImage(s,c,p),c<this._renderBoundaries[0]&&(this._renderBoundaries[0]=c),p<this._renderBoundaries[1]&&(this._renderBoundaries[1]=p),c+2*d>this._renderBoundaries[2]&&(this._renderBoundaries[2]=c+2*d),p+2*d>this._renderBoundaries[3]&&(this._renderBoundaries[3]=p+2*d)}},_colorize:function(){var t=this._renderBoundaries[0],e=this._renderBoundaries[1],a=this._renderBoundaries[2]-t,i=this._renderBoundaries[3]-e,n=this._width,r=this._height,s=this._opacity,o=this._maxOpacity,h=this._minOpacity,l=this._useGradientOpacity;t<0&&(t=0),e<0&&(e=0),t+a>n&&(a=n-t),e+i>r&&(i=r-e);for(var d=this.shadowCtx.getImageData(t,e,a,i),u=d.data,c=u.length,p=this._palette,_=3;_<c;_+=4){var f=u[_],g=4*f;if(g){var m;m=s>0?s:f<o?f<h?h:f:o,u[_-3]=p[g],u[_-2]=p[g+1],u[_-1]=p[g+2],u[_]=l?p[g+3]:m}}d.data=u,this.ctx.putImageData(d,t,e),this._renderBoundaries=[1e3,1e3,0,0]},getValueAt:function(t){var e=this.shadowCtx.getImageData(t.x,t.y,1,1).data[3],a=this._max,i=this._min;return Math.abs(a-i)*(e/255)>>0},getDataURL:function(){return this.canvas.toDataURL()}},t}(),i=function(){var e=!1;return"canvas2d"===t.defaultRenderer&&(e=a),e}(),n={merge:function(){for(var t={},e=arguments.length,a=0;a<e;a++){var i=arguments[a];for(var n in i)t[n]=i[n]}return t}},r=function(){function a(){var a=this._config=n.merge(t,arguments[0]||{});if(this._coordinator=new r,a.plugin){var o=a.plugin;if(!t.plugins[o])throw new Error("Plugin '"+o+"' not found. Maybe it was not registered.");var h=t.plugins[o];this._renderer=new h.renderer(a),this._store=new h.store(a)}else this._renderer=new i(a),this._store=new e(a);s(this)}var r=function(){function t(){this.cStore={}}return t.prototype={on:function(t,e,a){var i=this.cStore;i[t]||(i[t]=[]),i[t].push(function(t){return e.call(a,t)})},emit:function(t,e){var a=this.cStore;if(a[t])for(var i=a[t].length,n=0;n<i;n++){(0,a[t][n])(e)}}},t}(),s=function(t){var e=t._renderer,a=t._coordinator,i=t._store;a.on("renderpartial",e.renderPartial,e),a.on("renderall",e.renderAll,e),a.on("extremachange",function(e){t._config.onExtremaChange&&t._config.onExtremaChange({min:e.min,max:e.max,gradient:t._config.gradient||t._config.defaultGradient})}),i.setCoordinator(a)};return a.prototype={addData:function(){return this._store.addData.apply(this._store,arguments),this},removeData:function(){return this._store.removeData&&this._store.removeData.apply(this._store,arguments),this},setData:function(){return this._store.setData.apply(this._store,arguments),this},setDataMax:function(){return this._store.setDataMax.apply(this._store,arguments),this},setDataMin:function(){return this._store.setDataMin.apply(this._store,arguments),this},configure:function(t){return this._config=n.merge(this._config,t),this._renderer.updateConfig(this._config),this._coordinator.emit("renderall",this._store._getInternalData()),this},repaint:function(){return this._coordinator.emit("renderall",this._store._getInternalData()),this},getData:function(){return this._store.getData()},getDataURL:function(){return this._renderer.getDataURL()},getValueAt:function(t){return this._store.getValueAt?this._store.getValueAt(t):this._renderer.getValueAt?this._renderer.getValueAt(t):null}},a}();return{create:function(t){return new r(t)},register:function(e,a){t.plugins[e]=a}}}()}(0,this);var BMapLib=window.BMapLib=BMapLib||{};!function(){function t(){var t=document.createElement("canvas");return!(!t.getContext||!t.getContext("2d"))}var e=BMapLib.HeatmapOverlay=function(t){this.conf=t,this.conf.visible=void 0===t.visible||t.visible,this.heatmap=null,this.latlngs=[],this.bounds=null,this.conf.intervalPixel=15};e.prototype=new BMap.Overlay,e.prototype.initialize=function(e){this._map=e;var a=document.createElement("div");if(a.style.position="absolute",a.style.top=0,a.style.left=0,a.style.border=0,a.style.width=this._map.getSize().width+"px",a.style.height=this._map.getSize().height+"px",this.conf.element=a,!t())return a;e.getPanes().mapPane.appendChild(a),this.conf.valueField=this.conf.valueField||"count",this.heatmap=h337.create(this.conf);var i=this;return e.addEventListener("resize",function(t){var e=t.size;a.style.width=e.width+"px",a.style.height=e.height+"px",i.heatmap._renderer.setDimensions(e.width,e.height),i.draw()}),this._div=a,a},e.prototype.draw=function(){if(t()){var e=this._map.getBounds();if(!e.equals(this.bounds)){this.bounds=e;var a=this._map.pointToOverlayPixel(e.getNorthEast()),i=this._map.pointToOverlayPixel(e.getSouthWest()),n=a.y,r=i.x,s=i.y-a.y,o=a.x-i.x;if(this.conf.element.style.left=r+"px",this.conf.element.style.top=n+"px",this.conf.element.style.width=o+"px",this.conf.element.style.height=s+"px",this.latlngs.length>0){this.heatmap.removeData();var h=this.processData(),l=h.length;for(d={max:this.heatmap._store.getData().max,data:[]};l--;){var u=new BMap.Point(h[l].lng,h[l].lat),c=this._map.pointToOverlayPixel(u),r=this._map.pointToOverlayPixel(e.getSouthWest()).x,n=this._map.pointToOverlayPixel(e.getNorthEast()).y,p=new BMap.Pixel(c.x-r,c.y-n),_=this.pixelTransform(p);d.data.push({x:_.x,y:_.y,count:h[l].count})}this.conf.radiusChangeByZoom&&(this.heatmap._store._cfgRadius=this.conf.radiusChangeByZoom(this._map.getZoom())),this.heatmap.setData(d)}}}},e.prototype.processData=function(){for(var t=this.buildGrid(),e=[],a=this.toPixelData(this.data.data),i=0;i<t.length;i++){var n=this.interpolate(a,t[i].x,t[i].y),r=new BMap.Pixel(t[i].x,t[i].y);e.push({lng:this._map.overlayPixelToPoint(r).lng,lat:this._map.overlayPixelToPoint(r).lat,count:n.count})}return e},e.prototype.toPixelData=function(t){for(var e=[],a=0;a<t.length;a++){var i=t[a];if(this._map.getBounds().containsPoint(new BMap.Point(i.lng,i.lat))){var n=this._map.pointToOverlayPixel(new BMap.Point(i.lng,i.lat));e.push({x:n.x,y:n.y,count:i.count})}}return console.log(e.length),e},e.prototype.buildGrid=function(){for(var t=this._map.getBounds(),e=t.getSouthWest(),a=t.getNorthEast(),i=this._map.pointToOverlayPixel(e),n=this._map.pointToOverlayPixel(a),r=n.x-i.x,s=i.y-n.y,o=[],h=this.conf.intervalPixel,l=0;l<=r/h;l++)for(var d=0;d<=s/h;d++){var u=i.x+l*h,c=n.y+d*h;new BMap.Pixel(u,c);o.push({x:u,y:c,count:0})}return o},e.prototype.interpolate=function(t,e,a){var i=0,n=0,r={};return t.forEach(function(t){i+=1*t.count/((a-t.y)*(a-t.y)+(e-t.x)*(e-t.x)),0!=(n+=1/((a-t.y)*(a-t.y)+(e-t.x)*(e-t.x)))&&(r.count=i/n)}),r},e.prototype.pixelTransform=function(t){for(var e=this.heatmap.width,a=this.heatmap.height;t.x<0;)t.x+=e;for(;t.x>e;)t.x-=e;for(;t.y<0;)t.y+=a;for(;t.y>a;)t.y-=a;return t.x=t.x>>0,t.y=t.y>>0,t},e.prototype.setDataSet=function(e){this.data=e,t()&&this.setDataSetInner(e)},e.prototype.setDataSetInner=function(t){var e=this._map.getBounds(),a=this.processData(),i={max:t.max,data:[]},n=a,r=n.length;for(this.latlngs=[],this.heatmap.removeData(),this.conf.radiusChangeByZoom&&(this.heatmap._store._cfgRadius=this.conf.radiusChangeByZoom(this._map.getZoom()));r--;){var s=new BMap.Point(n[r].lng,n[r].lat);if(this.latlngs.push({latlng:s,c:n[r].count}),e.containsPoint(s)){var o=this._map.pointToOverlayPixel(s),h=this._map.pointToOverlayPixel(e.getSouthWest()).x,l=this._map.pointToOverlayPixel(e.getNorthEast()).y,d=new BMap.Pixel(o.x-h,o.y-l),u=this.pixelTransform(d);i.data.push({x:u.x,y:u.y,count:n[r].count})}}this.heatmap.setData(i)},e.prototype.addDataPoint=function(e,a,i){if(t()){this.data&&this.data.data&&this.data.data.push({lng:e,lat:a,count:i});var n=new BMap.Point(e,a),r=this.pixelTransform(this._map.pointToOverlayPixel(n));this.heatmap.store.addDataPoint(r.x,r.y,i),this.latlngs.push({latlng:n,c:i})}},e.prototype.toggle=function(){t()&&(!0===this.conf.visible?this.conf.visible=!1:this.conf.visible=!0,this.conf.visible?this.conf.element.style.display="block":this.conf.element.style.display="none")},e.prototype.setOptions=function(e){if(t()){for(var a in e)"radius"==a&&(this.heatmap._store._cfgRadius=e[a]),"opacity"==a&&(e[a]=e[a]/100);this.heatmap.configure(e),this.data&&this.setDataSet(this.data)}}}();