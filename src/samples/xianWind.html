<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge">
    <meta name="viewport" content="width=device-width, initial-scale=1" user-scalable="no">
    <title>动态风流场</title>
    <link rel="stylesheet" href="../css/style.css">
    <script type="text/javascript" src="https://api.map.baidu.com/api?v=2.0&ak=nuWah68S1WieW2AEwiT8T3Ro&s=1"></script>
    <script type="text/javascript" src="js/heatmap.js"></script>
    <script type="text/javascript" src="../mapstyle/darkblue.js"></script>
    <script type="text/javascript" src="../js/canvas2image.js"></script>
    <script type="text/javascript" src="../data/xian-wind-data.js"></script>
</head>

<body>
    <div id="map"></div>
    <script type="text/javascript" src="../js/painter/wind.js"></script>
    <script type="text/javascript" src="../js/dat.gui.js"></script>
    <script type="text/javascript">
        var map = new BMap.Map('map', {
            minZoom: 5
        });


        map.centerAndZoom(new BMap.Point(108.9469528198, 34.2699847970), 11);
        // map.centerAndZoom('西安', 11)
        map.enableScrollWheelZoom(true);
        map.setMapStyle({
            styleJson: styleJson
        });


        /************定义canvas图层************/
        function WindOverLayer() {}

        // var rectPoints = [108.65375518795702, 34.398623983579384, 109.02995109554979, 34.19661129231597]; //左上、右下经纬度

        WindOverLayer.prototype = new BMap.Overlay();

        WindOverLayer.prototype.initialize = function() {
            var canvas = document.createElement('canvas');
            canvas.id = "windCanvas";
            canvas.width = map.getSize().width;
            canvas.height = map.getSize().height;
            canvas.style.position = 'absolute';
            canvas.style.top = 0;
            canvas.style.left = 0;
            map.getPanes().labelPane.appendChild(canvas);

            this._canvas = canvas;
            this._windy = new Windy({
                map: map,
                canvas: canvas,
                data: windData
            });
        };

        WindOverLayer.prototype.draw = function() {
            var canvas = this._canvas;
            var windy = this._windy;
            var bounds = map.getBounds(); //返回当前视口的西南纬度/经度和东北纬度/经度
            var sw = bounds.getSouthWest();
            var ne = bounds.getNorthEast();
            var py = map.pointToOverlayPixel(new BMap.Point(sw.lng, ne.lat)); //经纬度转成屏幕坐标
            canvas.style.left = py.x + 'px';
            canvas.style.top = py.y + 'px';

            var points = this.invertLatLon(py); //所有站点经纬度转为canvas坐标
            // var min = map.pointToOverlayPixel(new BMap.Point(rectPoints[0], rectPoints[1]));
            // var max = map.pointToOverlayPixel(new BMap.Point(rectPoints[2], rectPoints[3]));
            var min = map.pointToOverlayPixel(new BMap.Point(sw.lng, ne.lat));
            var max = map.pointToOverlayPixel(new BMap.Point(ne.lng, sw.lat));

            windy.start([
                [min.x - py.x, min.y - py.y],
                [max.x - py.x, max.y - py.y]
            ], points);
        }

        WindOverLayer.prototype.invertLatLon = function(py) {
            var points = [];
            windData.forEach(function(station) {
                var px = map.pointToOverlayPixel(new BMap.Point(station[1], station[0]));
                points.push({
                    x: px.x - py.x,
                    y: px.y - py.y,
                    angle: station[2],
                    speed: station[3]
                });
            });
            return points;
        }

        var windLayer = new WindOverLayer()
        map.addOverlay(windLayer);

        var options = {
            size: .8,
            color: 'rgba(71,160,233,0.8)',
            button: function() {
                var oCanvas = document.getElementsByClassName("heatmap-canvas")[0];
                Canvas2Image.saveAsPNG(oCanvas);
            }
        };

        function finished() {
            windLayer._windy.change(options);
        };

        var gui = new dat.GUI({
            nameMap: {
                size: '线条大小',
                color: '线条颜色',
                button: '导出'
            }
        });

        finished();
        gui.add(options, 'size', 0.1, 10).onFinishChange(finished);
        gui.addColor(options, 'color').onChange(finished);
        gui.add(options, 'button');

        var heatmapOverlay2;

        function addCo(map) {
            var point;
            heatmapOverlay2 = new BMapLib.HeatmapOverlay({
                "radius": 200,
                "opacity": 0.3
            });
            map.addOverlay(heatmapOverlay2);

            fetch("/data/co.json").then(function(response) {
                return response.json().then(function(json) {
                    point = json.data;
                    heatmapOverlay2.setDataSet({
                        data: point,
                        max: 16
                    });
                })
            });
        }

        map.addEventListener("zoomend", function() {
            // heatmapOverlay2.setOption({
            //    "radius": this.getZoom() * 50
            // });
        });

        /*
                var tileLayer = new BMap.TileLayer({
                    isTransparentPng: true
                });
                tileLayer.getTilesUrl = function(tileCoord, zoom) {
                    var x = tileCoord.x;
                    var y = tileCoord.y;
                    var u = '/tiles/' + zoom + '/tile-' + x + '_' + y + '.png';
                    return u;
                }
                map.addTileLayer(tileLayer);
        */
        addCo(map);
    </script>
</body>

</html>